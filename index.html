<!DOCTYPE HTML>

<html>

  <head>
  	<title>Write your thing!</title>
	  <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        * {
            color: #1A0423;
        }

        .day-streak {
            background-color: #BF8CD3;
            width: 30px;
            border: 2px solid #581F6E;
            border-radius: 3px;
            height: 30px;
            display: inline-block;
            margin: 1px;
        }

        .complete {
            background-color: #581F6E;
        }

        .container {
            width: 60%;
        }

        textarea {
            padding: 5px;
        }

        .entry-text {
            background-color: #F9ECFE;
            color: #581F6E;
            border: 2px solid #581F6E;
            border-radius: 3px;
            width: 100%;
            height: 70%;
            border: 1px solid #;
            margin: 0.5em auto;
        }

        body {
            background-color: #BF8CD3;
        }
    </style>
  </head>

  <body>

	<div class="container">

	  <div class="row">
          <h1>Write your thing!</h1>
	  </div>

	  <div class="row week-streak">
	  </div>

	  <div class="row">
	    <textarea name="entry" class="entry-text" rows="25">Lorem Ipsum.
	    </textarea>
	  </div>

	  <div class="row">
	    <span class="word-count"></span>
	    <span class="messages pull-right"></span>
	  </div>

	</div>

    <script>
	$(function(){
	  var autosaveIntervalSeconds = 10;
	  var storagePrefix = "rc_sp1_writingapp_";

	 var saveToLocalStorage = function(key, value){
	 	localStorage.setItem(storagePrefix + key, value);
	 }

	 var retrieveFromLocalStorage = function(key) {
	 	return localStorage.getItem(storagePrefix + key);
	 }

	 var saveEntry = function(){
	    var date = getFormattedDate(new Date());
	    var entry = $('.entry-text').val();
	    saveToLocalStorage(date, entry);
	    $(".messages").html("Saved").show().delay(1000).fadeOut("slow");
      console.log('entry saved');
	    console.log(localStorage.getItem(date)); // check it's there
	  }

	  setInterval(saveEntry, autosaveIntervalSeconds * 1000);


		var updateWeekStreakWidget = function(data) {
	    // map -> array of html elements
	    var elements = data.map(function(complete) {
          if (complete) {
                return '<span class="day-streak complete">&nbsp;</span>'
	      } else {
              return '<span class="day-streak incomplete">&nbsp;</span>'
	      }
	    })
	     // clear and append array
	  	$('.week-streak').html('').append(elements);
	  }

	  function countwords(text) {
	  	var words = text.split(/\s/).filter(function(word){
	    	return word.length;
	    })
	  	return words.length;
	  }

	  var updateWordCountWidget = function(){
	  	var text = $('.entry-text').val();
	    var count = countwords(text);
	    $('.word-count').text(count + " words");
	  }
	  $('.entry-text').on('keyup', updateWordCountWidget);



    function getFormattedDate(date_object) {
      var dd = date_object.getDate();
      var mm = date_object.getMonth() + 1; //January is 0!
      var yyyy = date_object.getFullYear();
      dd = (dd < 10) ? ('0' + dd) : dd;
      mm = (mm < 10) ? ('0' + mm) : mm;
      return dd + '_' + mm + '_' + yyyy;
    }

    function getDatesFromPastSevenDays() {
      var dt = new Date();
      var ret = [];
     for (var i=0; i<7; i++) {
          formatted_date = getFormattedDate(new Date(dt))
          //unshift adds to beginning, so dates are in ascending order
          ret.unshift(formatted_date);
          dt.setDate(dt.getDate() - 1);
      }
      return ret;
    }

    function getWeekStreak(streakDates) {
      var weekStreak = [];
      // maybe we should save the entries in a dictionary instead of just the streak
      for (var i=0; i<streakDates.length; i++) {
        var key = "rc_sp1_writingapp_" + streakDates[i];
        var entry = localStorage.getItem(key);
        if (entry) {
          weekStreak.push(true);
        } else {
          weekStreak.push(false);
        }
      }
      return weekStreak;
    }

    var currentEntry = retrieveFromLocalStorage(getFormattedDate(new Date()));
    $('.entry-text').val(currentEntry);
    console.log('currentEntry', currentEntry);

    var streakDates = getDatesFromPastSevenDays();
    console.log('getDatesFromPastSevenDays', streakDates);

    var weekStreak = getWeekStreak(streakDates)
    console.log('weeke strea: ', weekStreak);

     updateWeekStreakWidget(weekStreak);

    updateWordCountWidget();



	});


    </script>

   </body>
</html>
